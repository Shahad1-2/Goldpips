<script>
  document.addEventListener("DOMContentLoaded", () => {
    const token = localStorage.getItem("goldpips_token");
    if (!token) {
      // Handle missing token without redirecting
      console.warn("No token found.");
      alert("No session found. Please log in.");
      return;
    }

    fetch("http://localhost:5000/api/dashboard", {
      headers: { Authorization: `Bearer ${token}` }
    })
      .then(res => {
        if (!res.ok) throw new Error("Unauthorized");
        return res.json();
      })
      .then(data => populateDashboard(data))
      .catch(err => {
        console.error(err);
        alert("Session expired or invalid. Please log in.");
        // No redirect here
      });
  });

  function populateDashboard(data) {
    document.getElementById("userEmail").innerText = "Welcome, " + data.email;
    document.getElementById("plan").innerText = `${data.plan} (₹1000)`;
    document.getElementById("roi").innerText = `₹${data.roi}`;
    document.getElementById("totalEarned").innerText = `₹${data.totalEarned}`;
    document.getElementById("referralEarnings").innerText = `₹${data.referralEarnings}`;
    document.getElementById("refLink").value = data.referralLink;

    if (data.referrer) {
      document.getElementById("referrerInfo").classList.remove("d-none");
      document.getElementById("referrerName").innerText = data.referrer;
    }

    const levelList = document.getElementById("levelList");
    levelList.innerHTML = (data.levels || []).map(
      lvl => `<li class="list-group-item">Level ${lvl.level}: ${lvl.count} Referrals – ₹${lvl.amount}</li>`
    ).join("");

    const txnTable = document.getElementById("txnTable");
    txnTable.innerHTML = (data.transactions || []).map(tx => `
      <tr>
        <td>${new Date(tx.date).toLocaleDateString()}</td>
        <td>${tx.type}</td>
        <td>₹${tx.amount}</td>
        <td class="${tx.status === 'Success' ? 'text-success' : 'text-warning'}">${tx.status}</td>
      </tr>
    `).join("");
  }

  function logout() {
    localStorage.clear();
    // No redirect here
    alert("Logged out. Please close the browser tab or refresh to log in again.");
  }

  function copyLink() {
    const link = document.getElementById("refLink").value;
    navigator.clipboard.writeText(link)
      .then(() => alert("Referral link copied to clipboard!"))
      .catch(err => alert("Failed to copy link: " + err));
  }
</script>
